---
title: 关于Ae中 模糊算法的比对 与 选用策略
tags: ["Ae","算法","计算机","影視"]
updated: 2020-01-16
date: 2020-01-14
categories: "影視"
---
---

## 前言

本文记录了在使用模板时候，因套用模糊工具导致渲染速度变慢引发的思考，进而探究两种模糊算法之间的优劣以及选用策略。

![](/asset/images/毕业后/blur/04.png)

### TL;DR

**高斯模糊效果好，时间久（均值模糊的两倍到四倍），均值模糊（快速方框模糊、Box Blur）快，效果接近高斯模糊**。且ae是先运算**效果器**，再运算**变换**，原图有多大，运算量就有多大。当然，这次渲染变慢的原因不止这一个，详见[Ae提速挖坑指北](/post/%E5%BD%B1%E8%A7%86/aeup/index.html)。

<!--more-->

## 起因

在套一个模板的时候（汇聚），一个画面同时引入60张照片，每张照片都是**顶图全部展现，背景拉满+高斯模糊80像素**，结果原本15分钟的模板活活渲染了2个小时，开始思考原因。

后来了解到，ae在计算的时候，不会使用**预合成渲染**，而是直接使用**穿透合成渲染**，即：
```
预合成渲染 = 渲染预合成的结果 + 外面使用这个结果
穿透合成渲染 = 每次渲染到这个预合成，都重新渲染一遍
```

这就意味着，一张静态图，如果按照ae的算法，得计算**帧数**次，特别是模糊等其他内容：1000帧的静态预合成，按ae的算法，得重复计算1000次。

这就很没有必要了，那天晚上的计算量=375帧（15秒）\*50张照片=18750次，我把没必要的模糊运算重复运算了18750遍，按每张照片200万像素来算，**额外运算了375亿次半径为80像素的高斯模糊运算**

这一篇主要聊聊ae中模糊算法的比对与选用策略

## 主流模糊算法

### 慢速优质——高斯模糊

高斯模糊是基于像素点的某个半径中，以二维正态分布为权重的卷积计算，得到新的模糊值组成新图案

简单来说就是下面这种表达：

[![](/asset/images/毕业后/blur/02.webp)](https://mlnotebook.github.io/post/CNN1/)

左边是原图，中间是正态分布的权重，右边是结果

保守运算量，同类项合并后，约=[图片像素数量\*πR<sup>2</sup>次]()加法运算+[图片像素数量\*R次]()浮点乘法运算。

### 迷之翻译——快速方框模糊

原名应该是``box blur``（均值模糊），这里的box用于指代方形框架顶点类似的分布，国内翻译成“快速方框模糊”

均值模糊的好处在于在一次计算中，把所有附近的点采用相同的权重，一次缓存足以给整张图使用。将第一次结果作为第二次的初始数据输入，迭代出更优秀的模糊效果。

![](/asset/images/毕业后/blur/03.png)

用表格做了一个一维数据组的**高斯模糊**跟**均值模糊**对比，由图可见，随着迭代曾佐，与高斯的方差越来越小（但是与原图差距越来越大），有最佳拟合值（此处均值半径为1，高斯半径为2，最佳迭代次数是3）

保守运算量=([图片像素数量\*πR<sup>2</sup>次]()加法运算+[图片像素数量次]()浮点乘法运算)*[迭代次数]()。

## 对比
模糊类型|效果|性能|计算量
---|---|---|---
高斯模糊|低通，可有效抹除高频碍眼部分|慢|O(pπR<sup>2</sup>+Rp)
均值模糊<br />(快速方框模糊)|笼统模糊，可通过多次迭代达到高斯类似效果，迭代过多易失真|快|O(pπR<sup>2</sup>t),t>1

实际使用中，一张两百万像素（1920*1080）照片进行上述两种运算，均值R=33,t=3和高斯R=100有接近的效果，代入可得

```
高斯模糊≈20,000Mπ+200M运算量
均值模糊≈6534Mπ
```

注：以上并不是正规的运算时间计算方法，只是基于理论的一点推断。具体还要考虑到算法优化、处理器优化以及**你电脑心情**等因素。

其他大部分算法如``CC Cross Blur``是基于高斯模糊、``径向模糊``是基于图像自身位移而不是模糊算法。具体用的什么算法，可以自己建一个4\*4px的小合成+1\*1px的纯色层尝试一下看效果。

在去高频方面，高斯模糊用于解决画面高频上的能力要优于均值模糊，比如**画面噪点、摩尔纹**，用均值模糊就会发现他把那些高频+低频部分（比如天空）揉成一片，高斯模糊会把高频挡掉，但不会过于阻碍低频的内容

![](/asset/images/毕业后/blur/04.png)

在使用模糊使得高频达到近似效果时，彩色图会有比较明显区别，低频部分的显现也明显不一样。

## 总结

**高斯模糊效果好，时间久（均值模糊的两倍到四倍），均值模糊（快速方框模糊、Box Blur）快，效果接近高斯模糊**。且ae是先运算**效果器**，再运算**变换**，原图有多大，运算量就有多大。当然，这次渲染变慢的原因不止这一个，详见[Ae提速汇总](/post/%E5%BD%B1%E8%A7%86/aeup/index.html)。


## 参考链接

[高斯模糊的算法 阮一峰的博客](http://www.ruanyifeng.com/blog/2012/11/gaussian_blur.html)

[快速高斯模糊（均值模糊）](https://blog.csdn.net/poi7777/article/details/42709881)

[什么是图像模糊？如何实现简单的模糊和高斯模糊？](https://zhuanlan.zhihu.com/p/43907816)

[高斯模糊 - Wikiwand](https://www.wikiwand.com/zh-tw/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A)